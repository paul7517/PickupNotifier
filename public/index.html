<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
  <title>æ¥é€ç¥éšŠå‹ v9</title>
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #000;
      --card: #1a1a1a;
      --border: #2a2a2a;
      --text: #fff;
      --sub: #8e8e93;
      --blue: #276ef1;
      --green: #06c167;
      --red: #e11900;
      --orange: #ff9500;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    #connBanner {
      display: none;
      width: 100%;
      padding: 0.5rem;
      background: var(--red);
      text-align: center;
      font-size: 0.8rem;
      font-weight: 600;
      color: #fff;
      position: fixed;
      top: 0;
      z-index: 999;
      animation: blink 1.5s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.5;
      }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem 0.5rem;
    }

    .top-bar h1 {
      font-size: 1.2rem;
      font-weight: 900;
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--card);
      border: 1px solid var(--border);
      color: #fff;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .status-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .status-emoji {
      font-size: 4.5rem;
      margin-bottom: 0.5rem;
      transition: transform 0.3s;
    }

    .status-emoji.pulse {
      animation: bounce 1.5s infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: scale(1)
      }

      50% {
        transform: scale(1.12)
      }
    }

    .status-headline {
      font-size: 1.5rem;
      font-weight: 900;
      text-align: center;
      line-height: 1.3;
      margin-bottom: 0.2rem;
    }

    .status-sub {
      font-size: 0.95rem;
      color: var(--sub);
      text-align: center;
    }

    .progress-bar {
      display: flex;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.8rem;
    }

    .pdot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      transition: 0.3s;
    }

    .pdot.active {
      background: var(--green);
      width: 24px;
      border-radius: 4px;
    }

    .pdot.done {
      background: var(--green);
    }

    .card {
      background: var(--card);
      border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      padding: 1.5rem 1.2rem env(safe-area-inset-bottom, 1rem);
      width: 100%;
    }

    .card-handle {
      width: 36px;
      height: 4px;
      background: #444;
      border-radius: 2px;
      margin: 0 auto 1rem;
    }

    .btn {
      width: 100%;
      padding: 1.1rem;
      border: none;
      border-radius: 14px;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .btn:active {
      transform: scale(0.97);
      opacity: 0.9;
    }

    .btn:last-child {
      margin-bottom: 0;
    }

    .btn-green {
      background: var(--green);
      color: #fff;
    }

    .btn-blue {
      background: var(--blue);
      color: #fff;
    }

    .btn-dark {
      background: #2a2a2a;
      color: #fff;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid #444;
      color: #fff;
    }

    .btn-red {
      background: var(--red);
      color: #fff;
    }

    .btn[disabled] {
      opacity: 0.35;
      pointer-events: none;
    }

    .info-row {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.7rem 0;
      border-bottom: 1px solid #222;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-icon {
      font-size: 1.4rem;
    }

    .info-label {
      font-size: 0.75rem;
      color: var(--sub);
    }

    .info-value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.8rem;
    }

    .chip {
      padding: 0.5rem 0.9rem;
      border-radius: 100px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      color: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
    }

    .chip.on {
      background: var(--green);
      border-color: var(--green);
    }

    .chip:active {
      transform: scale(0.95);
    }

    .uber-input {
      width: 100%;
      padding: 0.8rem 1rem;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #3a3a3a;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: 0.2s;
      margin-bottom: 0.6rem;
    }

    .uber-input:focus {
      border-color: var(--blue);
    }

    .uber-input.ok {
      border-color: var(--green);
    }

    .eta-big {
      text-align: center;
      padding: 0.8rem 0;
    }

    .eta-num {
      font-size: 3.2rem;
      font-weight: 900;
      color: var(--green);
      letter-spacing: -2px;
    }

    .eta-label {
      font-size: 0.9rem;
      color: var(--sub);
    }

    .stepper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      margin: 0.6rem 0;
    }

    .step-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #2a2a2a;
      border: 1px solid #444;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-btn:active {
      background: #444;
    }

    .step-val {
      font-size: 2rem;
      font-weight: 900;
      min-width: 50px;
      text-align: center;
    }

    .cancel-link {
      display: block;
      text-align: center;
      color: var(--sub);
      font-size: 0.85rem;
      margin-top: 0.8rem;
      cursor: pointer;
      text-decoration: underline;
    }

    .gps-bar {
      text-align: center;
      padding: 0.4rem;
      margin-bottom: 0.6rem;
      border-radius: 8px;
      font-size: 0.78rem;
      font-weight: 600;
      background: #1a1a1a;
      color: #888;
    }

    .step {
      display: none;
    }

    .step.on {
      display: block;
    }

    .timeline-toggle {
      background: none;
      border: none;
      color: var(--sub);
      font-size: 0.8rem;
      padding: 0.4rem 0;
      cursor: pointer;
      width: 100%;
      text-align: left;
    }

    .tl-list {
      display: none;
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.72rem;
    }

    .tl-list.open {
      display: block;
    }

    .tl-entry {
      color: var(--sub);
      padding: 0.15rem 0;
      display: flex;
      gap: 0.4rem;
    }

    .tl-time {
      color: var(--blue);
      min-width: 42px;
    }

    #liveMapWrap {
      width: 100%;
      height: 200px;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 0.8rem;
      background: #111;
      position: relative;
    }

    #liveMap {
      width: 100%;
      height: 100%;
    }

    #mapOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      color: #888;
      font-size: 0.85rem;
    }

    .dot-loader {
      display: flex;
      gap: 6px;
      justify-content: center;
    }

    .dot-loader span {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--green);
      animation: dp 1.2s infinite ease-in-out;
    }

    .dot-loader span:nth-child(2) {
      animation-delay: 0.2s
    }

    .dot-loader span:nth-child(3) {
      animation-delay: 0.4s
    }

    @keyframes dp {

      0%,
      80%,
      100% {
        transform: scale(0.4);
        opacity: 0.3
      }

      40% {
        transform: scale(1);
        opacity: 1
      }
    }

    #confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      display: none;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 1.5rem;
      width: 90%;
      max-width: 360px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-box h3 {
      margin-bottom: 1rem;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0;
      border-bottom: 1px solid #222;
      font-size: 0.9rem;
    }

    .sw {
      width: 44px;
      height: 24px;
      background: #444;
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: 0.3s;
      border: none;
    }

    .sw.on {
      background: var(--green);
    }

    .sw::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: 0.3s;
    }

    .sw.on::after {
      left: 23px;
    }

    .qr-box {
      text-align: center;
      margin-top: 0.5rem;
    }

    .qr-box img {
      border-radius: 8px;
    }

    .qr-url {
      font-size: 0.65rem;
      color: var(--sub);
      margin-top: 0.3rem;
      word-break: break-all;
    }

    /* Drive Visualization */
    .drive-viz {
      background: linear-gradient(180deg, #0a1628 0%, #111 100%);
      border-radius: 16px;
      padding: 1.5rem 1.2rem 0.8rem;
      margin-bottom: 0.8rem;
      border: 1px solid #1e3a5f;
      position: relative;
      overflow: hidden;
    }

    .drive-viz::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(ellipse at 80% 50%, rgba(6, 193, 103, 0.08) 0%, transparent 60%);
      pointer-events: none;
    }

    .drive-road {
      position: relative;
      height: 56px;
      display: flex;
      align-items: center;
    }

    .drive-dashes {
      position: absolute;
      top: 50%;
      left: 40px;
      right: 40px;
      height: 2px;
      background: repeating-linear-gradient(90deg, #2a4a6a 0px, #2a4a6a 12px, transparent 12px, transparent 24px);
      animation: dashMove 1.5s linear infinite;
    }

    @keyframes dashMove {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: -24px 0;
      }
    }

    .drive-car {
      position: absolute;
      font-size: 2.4rem;
      left: 10%;
      z-index: 2;
      filter: drop-shadow(0 0 12px rgba(6, 193, 103, 0.4));
      transition: left 1s ease-in-out;
      animation: carBounce 2s ease-in-out infinite;
    }

    @keyframes carBounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-3px);
      }
    }

    .drive-pin {
      position: absolute;
      right: 8px;
      font-size: 2rem;
      z-index: 2;
      animation: pinPulse 2s ease-in-out infinite;
    }

    @keyframes pinPulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.15);
      }
    }

    .drive-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #4a7a9a;
      margin-top: 0.3rem;
      padding: 0 0.2rem;
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>
  <div id="connBanner">é€£ç·šä¸­æ–·ï¼Œé‡æ–°é€£ç·šä¸­...</div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal-box">
      <h3>âš™ï¸ è¨­å®š</h3>
      <div class="setting-row"><span>ğŸ”Š éŸ³æ•ˆ</span><button class="sw on" id="swSound" onclick="tgl('sound')"></button>
      </div>
      <div class="setting-row"><span>ğŸ“³ éœ‡å‹•</span><button class="sw on" id="swVibe" onclick="tgl('vibrate')"></button>
      </div>
      <div class="setting-row" style="flex-direction:column;align-items:flex-start;">
        <span>ğŸ·ï¸ è‡ªè¨‚æ¨™ç±¤ (æ¯è¡Œä¸€å€‹)</span>
        <textarea id="tagEdit" rows="3"
          style="width:100%;margin-top:0.5rem;background:#0d1117;color:#fff;border:1px solid #444;border-radius:8px;padding:0.5rem;font-size:14px;resize:none;"></textarea>
        <button onclick="saveTags()"
          style="margin-top:0.4rem;padding:0.3rem 0.8rem;background:var(--green);color:#fff;border:none;border-radius:8px;font-size:0.8rem;cursor:pointer;">å„²å­˜</button>
      </div>
      <div class="setting-row" style="flex-direction:column;align-items:flex-start;">
        <span>ğŸ“± QR Code</span>
        <div class="qr-box" id="qrBox">è¼‰å…¥ä¸­...</div>
      </div>
      <div class="setting-row"><span>ğŸ“¡ é »é“</span><span id="rmDisp" style="color:var(--blue);">default</span></div>
      <button onclick="closeSett()"
        style="width:100%;padding:0.7rem;margin-top:1rem;background:var(--blue);color:#fff;border:none;border-radius:12px;font-size:1rem;font-weight:700;cursor:pointer;">é—œé–‰</button>
    </div>
  </div>

  <div class="top-bar">
    <h1 id="appTitle">ğŸš— æ¥é€ç¥éšŠå‹</h1>
    <button class="icon-btn" onclick="openSett()">âš™ï¸</button>
  </div>

  <div class="status-area">
    <div class="status-emoji" id="sEmoji">â˜•</div>
    <div class="status-headline" id="sHead">â€”</div>
    <div class="status-sub" id="sSub">â€”</div>
  </div>

  <div class="progress-bar" id="pBar">
    <div class="pdot active"></div>
    <div class="pdot"></div>
    <div class="pdot"></div>
    <div class="pdot"></div>
  </div>

  <div class="card">
    <div class="card-handle"></div>

    <!-- ====== RIDER STEPS ====== -->
    <div class="step on" id="r0">
      <div class="chip-group" id="chips"></div>
      <div style="position:relative;">
        <input type="text" class="uber-input" id="meetPt" placeholder="è¼¸å…¥æœƒåˆé»ï¼Œæˆ–é»é¸ä¸Šæ–¹æ¨™ç±¤" onInput="onMeet()">
        <button id="clearBtn" onclick="clearMeet()"
          style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#888;font-size:1.1rem;cursor:pointer;">âœ–</button>
      </div>
      <button class="btn btn-green" id="callBtn" onclick="callPickup()" disabled>å‘¼å«æ¥é€</button>
      <div style="text-align:center;color:var(--sub);font-size:0.8rem;margin-top:0.3rem;" id="meetHint">è¼¸å…¥æœƒåˆé»å¾Œå³å¯å‘¼å«</div>
    </div>

    <div class="step" id="r1">
      <div class="info-row"><span class="info-icon">ğŸ“</span>
        <div>
          <div class="info-label">æœƒåˆé»</div>
          <div class="info-value" id="r1Meet">â€”</div>
        </div>
      </div>
      <div style="text-align:center;padding:1.2rem 0;">
        <div style="color:var(--sub);">ç­‰å¾…å¸æ©Ÿç¢ºèªä¸­...</div>
        <div style="margin-top:0.6rem;">
          <div class="dot-loader"><span></span><span></span><span></span></div>
        </div>
      </div>
      <button class="btn btn-outline" onclick="riderMsg(5,'ç¼ºè²¨/çœ‹LINE')">ğŸ’¬ ç¼ºè²¨/ç™¼LINEäº†</button>
      <div class="cancel-link" onclick="cancelCall()">å–æ¶ˆå‘¼å«</div>
    </div>

    <div class="step" id="r2">
      <!-- Animated Car Approaching Visualization -->
      <div class="drive-viz">
        <div class="drive-road">
          <div class="drive-dashes"></div>
          <div class="drive-car" id="driveCar">ğŸš—</div>
          <div class="drive-pin">ğŸ“</div>
        </div>
        <div class="drive-labels">
          <span>å¸æ©Ÿå‡ºç™¼</span>
          <span id="r2MeetLabel">æœƒåˆé»</span>
        </div>
      </div>

      <div class="eta-big">
        <div class="eta-num" id="rEta">â€”</div>
        <div class="eta-label">é è¨ˆæŠµé”</div>
      </div>

      <!-- Google Maps link (if driver shared) -->
      <a class="btn btn-blue" id="gmapLink" href="#" target="_blank"
        style="display:none;text-decoration:none;margin-bottom:0.5rem;">
        ğŸ“ æŸ¥çœ‹å¸æ©Ÿå³æ™‚ä½ç½® (Google Maps)
      </a>

      <div class="info-row"><span class="info-icon">ğŸ“</span>
        <div>
          <div class="info-label">æœƒåˆé»</div>
          <div class="info-value" id="r2Meet">â€”</div>
        </div>
      </div>
      <button class="btn btn-green" onclick="riderMsg(4)">âœ… æˆ‘å·²åœ¨è·¯é‚Šç­‰</button>
      <button class="btn btn-outline" onclick="riderMsg(5,'å¡ä½ï¼Œå…ˆåˆ¥ä¾†')">â³ çµå¸³å¡ä½</button>
    </div>

    <div class="step" id="r3">
      <div style="text-align:center;padding:1rem 0;font-size:1.1rem;font-weight:700;" id="r3Title">â€”</div>
      <button class="btn btn-dark" onclick="resetAll()">å®Œæˆæ­ä¹˜</button>
    </div>

    <!-- ====== DRIVER STEPS ====== -->
    <div class="step" id="d0">
      <div style="text-align:center;padding:1rem 0;color:var(--sub);">ç›®å‰æ²’æœ‰æ¥é€è«‹æ±‚<br>ç­‰å¾…ä¹˜å®¢å‘¼å«ä¸­...</div>
    </div>

    <div class="step" id="d1">
      <div class="info-row"><span class="info-icon">ğŸ“</span>
        <div>
          <div class="info-label">æœƒåˆé»</div>
          <div class="info-value" id="d1Meet">â€”</div>
        </div>
      </div>
      <button class="btn btn-green" onclick="driverAccept()" style="margin-top:0.5rem;">æ¥å—ä¸¦å°èˆª</button>
    </div>

    <div class="step" id="d2">
      <button class="btn btn-blue" onclick="openMap()">ğŸ—ºï¸ é–‹å•Ÿåœ°åœ–å°èˆª</button>
      <div style="border:1px solid #333;border-radius:14px;padding:0.8rem;margin-bottom:0.6rem;background:#111;">
        <div style="font-size:0.8rem;color:var(--sub);margin-bottom:0.5rem;">ğŸ“ åˆ†äº«å³æ™‚ä½ç½®çµ¦ä¹˜å®¢ï¼ˆå¯çœç•¥ï¼‰</div>
        <div style="font-size:0.7rem;color:#666;margin-bottom:0.5rem;">1. é–‹å•Ÿ Google Maps â†’ é»ä½ çš„è—è‰²åœ“é» â†’ åˆ†äº«ä½ç½®è³‡è¨Š â†’ è¤‡è£½é€£çµ<br>2.
          è²¼åœ¨ä¸‹æ–¹å¾ŒæŒ‰ã€Œå‚³é€ã€</div>
        <div style="display:flex;gap:0.4rem;">
          <input type="text" class="uber-input" id="liveUrlInput" placeholder="è²¼ä¸Š Google Maps åˆ†äº«é€£çµ"
            style="margin-bottom:0;flex:1;font-size:14px;">
          <button onclick="sendLiveUrl()"
            style="padding:0.6rem 1rem;background:var(--green);color:#fff;border:none;border-radius:12px;font-weight:700;font-size:0.85rem;cursor:pointer;white-space:nowrap;">å‚³é€</button>
        </div>
      </div>
      <div style="font-size:0.8rem;color:var(--sub);margin-bottom:0.4rem;text-align:center;">å›å ±é è¨ˆæŠµé”åˆ†é˜æ•¸ï¼š</div>
      <div class="stepper">
        <button class="step-btn" onclick="adjEta(-1)">âˆ’</button>
        <div class="step-val" id="etaVal">3</div>
        <button class="step-btn" onclick="adjEta(1)">+</button>
      </div>
      <button class="btn btn-green" onclick="sendEta()">å›å ±æŠµé”æ™‚é–“</button>
    </div>

    <div class="step" id="d3">
      <div class="eta-big">
        <div class="eta-num" id="dEta">â€”</div>
        <div class="eta-label">å€’æ•¸ä¸­</div>
      </div>
      <button class="btn btn-blue" onclick="openMap()">ğŸ—ºï¸ é‡é–‹åœ°åœ–</button>
      <button class="btn btn-green" onclick="driverArrived()">âœ… æˆ‘å·²åˆ°é”æœƒåˆé»</button>
      <button class="btn btn-outline" onclick="driverWarn('è­¦å¯Ÿè¶•äººï¼Œæˆ‘è¦ç¹ä¸€åœˆ')">âš ï¸ ç¹è·¯ä¸­</button>
    </div>

    <div class="step" id="d4">
      <div style="text-align:center;padding:1rem 0;font-size:1.05rem;font-weight:600;" id="d4Title">â€”</div>
      <button class="btn btn-dark" onclick="resetAll()">å›åˆ°å¾…å‘½</button>
    </div>

    <div style="margin-top:0.6rem;">
      <button class="timeline-toggle" onclick="document.getElementById('tlList').classList.toggle('open')">ğŸ“‹ æ“ä½œç´€éŒ„
        â–¾</button>
      <div class="tl-list" id="tlList"></div>
    </div>
  </div>

  <audio id="alertSnd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"
    loop></audio>
  <audio id="pingSnd" src="https://assets.mixkit.co/active_storage/sfx/2868/2868-preview.mp3" preload="auto"></audio>
  <audio id="errSnd" src="https://assets.mixkit.co/active_storage/sfx/2955/2955-preview.mp3" preload="auto"></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const P = new URLSearchParams(location.search);
    const roomId = P.get('room') || 'default';
    const role = P.get('role') || 'rider';

    const socket = io({ query: { room: roomId } });
    let gs = { status: 0, eta: null, msg: '', meetPoint: '', targetTime: null };
    let audioOK = false, wakeLock = null, cdInt = null, tgtTime = null;

    // Settings
    let S = JSON.parse(localStorage.getItem('pS') || '{}');
    if (S.sound === undefined) S.sound = true;
    if (S.vibrate === undefined) S.vibrate = true;
    const defTags = ['å¤§é–€å£', 'åŸä¸‹è»Šè™•', 'æ—é‚Šå··å£', 'å°é¢é¦¬è·¯'];
    let tags = JSON.parse(localStorage.getItem('tags') || 'null') || defTags;

    // === Init ===
    document.getElementById('appTitle').textContent = role === 'driver' ? 'ğŸš™ å¸æ©Ÿç«¯' : 'ğŸ›’ ä¹˜å®¢ç«¯';
    document.getElementById('rmDisp').textContent = roomId;
    applyS();
    if (role === 'rider') renderChips();

    function renderChips() {
      const icons = ['ğŸšª', 'ğŸ”™', 'ğŸ›£ï¸', 'ğŸš¥', 'ğŸ“Œ', 'ğŸª', 'ğŸš', 'ğŸ…¿ï¸'];
      const g = document.getElementById('chips'); g.innerHTML = '';
      tags.forEach((t, i) => { const b = document.createElement('button'); b.className = 'chip'; b.textContent = (icons[i] || 'ğŸ“Œ') + ' ' + t; b.dataset.tag = t; b.onclick = () => togChip(t, b); g.appendChild(b); });
    }
    function togChip(t, el) { const inp = document.getElementById('meetPt'); let ps = inp.value.trim() ? inp.value.trim().split(' ') : []; const i = ps.indexOf(t); if (i > -1) { ps.splice(i, 1); el.classList.remove('on'); } else { ps.push(t); el.classList.add('on'); } inp.value = ps.join(' '); onMeet(); }
    function clearMeet() { document.getElementById('meetPt').value = ''; document.querySelectorAll('.chip').forEach(c => c.classList.remove('on')); onMeet(); }
    function restoreChips() { const v = document.getElementById('meetPt').value.trim(); const ps = v ? v.split(' ') : []; document.querySelectorAll('.chip').forEach(c => c.classList.toggle('on', ps.includes(c.dataset.tag))); }

    function onMeet() {
      const v = document.getElementById('meetPt').value.trim();
      const btn = document.getElementById('callBtn');
      const clr = document.getElementById('clearBtn');
      const inp = document.getElementById('meetPt');
      if (v) { btn.disabled = false; inp.classList.add('ok'); clr.style.display = 'block'; document.getElementById('meetHint').textContent = ''; socket.emit('change-state', { meetPoint: v }); }
      else { btn.disabled = true; inp.classList.remove('ok'); clr.style.display = 'none'; document.getElementById('meetHint').textContent = 'è¼¸å…¥æœƒåˆé»å¾Œå³å¯å‘¼å«'; }
      restoreChips();
    }

    // === Actions ===
    function callPickup() { unlock(); const m = document.getElementById('meetPt').value.trim(); socket.emit('change-state', { status: 2, meetPoint: m, msg: '', eta: null, timelineEvent: 'ğŸš¨ ä¹˜å®¢å‘¼å«æ¥é€' }); }
    function cancelCall() { socket.emit('change-state', { status: 0, msg: '', eta: null, timelineEvent: 'âŒ å–æ¶ˆå‘¼å«' }); }
    function riderMsg(s, m = '') { unlock(); stopAud(); const mp = document.getElementById('meetPt').value.trim(); const ev = { 4: 'âœ… ä¹˜å®¢åœ¨è·¯é‚Š', 5: 'âš ï¸ ' + (m || 'ç‹€æ³') }; socket.emit('change-state', { status: s, msg: m, meetPoint: mp, eta: null, timelineEvent: ev[s] || '' }); }
    function driverAccept() { unlock(); stopAud(); socket.emit('change-state', { status: 3, eta: null, targetTime: null, timelineEvent: 'ğŸš™ å¸æ©Ÿå·²æ¥å—' }); }
    function sendEta() { const e = parseInt(document.getElementById('etaVal').innerText) || 3; socket.emit('change-state', { status: 3, eta: e, targetTime: Date.now() + (e * 60000), timelineEvent: `ğŸš™ å¸æ©Ÿå‡ºç™¼ (${e}åˆ†)` }); }
    function driverArrived() { unlock(); stopAud(); socket.emit('change-state', { status: 4, msg: 'æˆ‘åˆ°äº†ï¼Œå¿«å‡ºä¾†', timelineEvent: 'âœ… å¸æ©Ÿå·²æŠµé”' }); }
    function driverWarn(m) { socket.emit('change-state', { status: 5, msg: m, timelineEvent: 'âš ï¸ ' + m }); }
    function openMap() { stopAud(); let m = gs.meetPoint || ''; if (m.startsWith('http')) window.open(m, '_blank'); else if (m) window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(m)}&travelmode=driving`, '_blank'); else alert('ä¹˜å®¢å°šæœªè¨­å®šæœƒåˆé»'); }
    function adjEta(d) { const el = document.getElementById('etaVal'); let v = parseInt(el.innerText) + d; if (v < 1) v = 1; if (v > 120) v = 120; el.innerText = v; }
    function resetAll() { unlock(); stopAud(); socket.emit('change-state', 0); }

    // === Socket ===
    socket.on('connect', () => { document.getElementById('connBanner').style.display = 'none'; });
    socket.on('disconnect', () => { document.getElementById('connBanner').style.display = 'block'; });

    socket.on('state-update', (s) => {
      gs = s;
      if (s.status === 3 && s.targetTime) { tgtTime = s.targetTime; if (cdInt) clearInterval(cdInt); cdInt = setInterval(updCD, 1000); updCD(); }
      else { if (cdInt) clearInterval(cdInt); cdInt = null; tgtTime = null; }
      if (s.status === 4 && s.msg === 'æˆ‘åˆ°äº†ï¼Œå¿«å‡ºä¾†') confettiGo(); else confettiStop();
      updateUI();
      doAudio();
    });

    socket.on('timeline-sync', (tl) => {
      const el = document.getElementById('tlList'); el.innerHTML = '';
      tl.slice().reverse().forEach(e => { const d = new Date(e.time); const t = `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; el.innerHTML += `<div class="tl-entry"><span class="tl-time">${t}</span><span>${e.event}</span></div>`; });
    });

    function updCD() {
      if (!tgtTime) return; let diff = tgtTime - Date.now();
      if (diff <= 0) { setEtaText('å³å°‡æŠµé”'); return; }
      const m = Math.floor(diff / 60000), s = Math.floor((diff % 60000) / 1000);
      setEtaText(`${m}:${s.toString().padStart(2, '0')}`);
    }
    function setEtaText(t) { const r = document.getElementById('rEta'); const d = document.getElementById('dEta'); if (r) r.innerText = t; if (d) d.innerText = t; }

    // === UI ===
    function updateUI() {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('on'));
      const em = document.getElementById('sEmoji'), hd = document.getElementById('sHead'), sb = document.getElementById('sSub');
      const meet = gs.meetPoint || 'æœªè¨­å®š';

      if (role === 'rider') {
        switch (gs.status) {
          case 0: em.textContent = 'ğŸ›’'; em.classList.remove('pulse'); hd.textContent = 'æº–å‚™å¥½äº†å—ï¼Ÿ'; sb.textContent = 'è¨­å®šæœƒåˆé»å¾Œå‘¼å«æ¥é€'; show('r0'); if (gs.meetPoint && !document.getElementById('meetPt').value) { document.getElementById('meetPt').value = gs.meetPoint; onMeet(); } break;
          case 2: em.textContent = 'ğŸ“¡'; em.classList.add('pulse'); hd.textContent = 'å·²å‘¼å«æ¥é€'; sb.textContent = 'ç­‰å¾…å¸æ©Ÿç¢ºèªä¸­...'; document.getElementById('r1Meet').textContent = meet; show('r1'); break;
          case 3: em.textContent = 'ğŸš™'; em.classList.add('pulse'); hd.textContent = gs.eta ? 'å¸æ©Ÿæ­£åœ¨å‰å¾€' : 'å¸æ©Ÿå·²æ¥å—'; sb.textContent = gs.eta ? `é è¨ˆ ${gs.eta} åˆ†é˜æŠµé”` : 'æ­£åœ¨ç¢ºèªè·¯ç·š...'; document.getElementById('r2Meet').textContent = meet; document.getElementById('r2MeetLabel').textContent = meet; show('r2'); updateCarPosition(); break;
          case 4: em.textContent = 'ğŸ‰'; em.classList.remove('pulse'); if (gs.msg === 'æˆ‘åˆ°äº†ï¼Œå¿«å‡ºä¾†') { hd.textContent = 'å¸æ©Ÿå·²åˆ°é”ï¼'; sb.textContent = 'å¿«ä¸Šè»Šï¼'; document.getElementById('r3Title').textContent = 'ğŸ‰ å¸æ©Ÿå·²åœ¨æœƒåˆé»ç­‰æ‚¨ï¼'; } else { hd.textContent = 'å·²é€šçŸ¥å¸æ©Ÿ'; sb.textContent = 'æ‚¨æ­£åœ¨è·¯é‚Šç­‰å¾…'; document.getElementById('r3Title').textContent = 'âœ… å·²é€šçŸ¥å¸æ©Ÿæ‚¨åœ¨è·¯é‚Šç­‰å¾…'; } show('r3'); break;
          case 5: em.textContent = 'âš ï¸'; em.classList.add('pulse'); hd.textContent = 'ç‹€æ³å›å ±'; sb.textContent = gs.msg || 'è«‹ç¨å€™'; show('r1'); break;
          default: show('r0');
        }
      } else {
        switch (gs.status) {
          case 0: em.textContent = 'â˜•'; em.classList.remove('pulse'); hd.textContent = 'å¾…å‘½ä¸­'; sb.textContent = 'ç­‰å¾…ä¹˜å®¢å‘¼å«...'; show('d0'); break;
          case 2: em.textContent = 'ğŸ””'; em.classList.add('pulse'); hd.textContent = 'æ”¶åˆ°æ¥é€è«‹æ±‚ï¼'; sb.textContent = 'è«‹ç¢ºèªæœƒåˆé»'; document.getElementById('d1Meet').textContent = meet; show('d1'); break;
          case 3: em.textContent = 'ğŸš™'; em.classList.add('pulse'); if (gs.eta && gs.targetTime) { hd.textContent = 'å‰å¾€æœƒåˆé»ä¸­'; sb.textContent = `é è¨ˆ ${gs.eta} åˆ†é˜`; show('d3'); } else { hd.textContent = 'å·²æ¥å—è«‹æ±‚'; sb.textContent = 'é–‹å•Ÿåœ°åœ–ä¸¦å›å ±æ™‚é–“'; show('d2'); } break;
          case 4: em.textContent = 'âœ¨'; em.classList.remove('pulse'); if (gs.msg === 'æˆ‘åˆ°äº†ï¼Œå¿«å‡ºä¾†') { hd.textContent = 'æ‚¨å·²æŠµé”'; sb.textContent = 'ç­‰å¾…ä¹˜å®¢ä¸Šè»Š'; document.getElementById('d4Title').textContent = 'âœ… ç­‰å¾…ä¹˜å®¢å‡ºä¾†...'; } else { hd.textContent = 'ä¹˜å®¢å·²åœ¨è·¯é‚Š'; sb.textContent = 'è«‹ç›¡é€Ÿå‰å¾€'; document.getElementById('d4Title').textContent = 'âœ… ä¹˜å®¢å·²åœ¨è·¯é‚Šç­‰å¾…'; } show('d4'); break;
          case 5: em.textContent = 'âš ï¸'; em.classList.add('pulse'); hd.textContent = 'ç‹€æ³å›å ±'; sb.textContent = gs.msg || ''; show(gs.eta ? 'd3' : 'd1'); break;
          default: show('d0');
        }
      }
      updProgress();
    }
    function show(id) { document.getElementById(id).classList.add('on'); }
    function updProgress() { const dots = document.querySelectorAll('.pdot'); const m = { 0: 0, 2: 1, 3: 2, 4: 3, 5: 2 }; const c = m[gs.status] ?? 0; dots.forEach((d, i) => { d.className = 'pdot'; if (i < c) d.classList.add('done'); else if (i === c) d.classList.add('active'); }); }

    // === Live Location Sharing ===
    function sendLiveUrl() {
      const inp = document.getElementById('liveUrlInput');
      const url = inp.value.trim();
      if (!url) { alert('è«‹å…ˆè²¼ä¸Š Google Maps åˆ†äº«é€£çµ'); return; }
      socket.emit('change-state', { liveMapUrl: url, timelineEvent: 'ğŸ“ å¸æ©Ÿåˆ†äº«å³æ™‚ä½ç½®' });
      inp.value = '';
      alert('âœ… å·²å‚³é€çµ¦ä¹˜å®¢ï¼');
    }

    // Car animation: position based on ETA remaining
    function updateCarPosition() {
      const car = document.getElementById('driveCar');
      if (!car) return;
      if (!tgtTime || !gs.eta) {
        car.style.left = '10%';
        return;
      }
      const total = gs.eta * 60000;
      const remaining = Math.max(0, tgtTime - Date.now());
      const progress = 1 - (remaining / total);
      // Car goes from 10% to 75% (pin is at ~85%)
      const pos = 10 + (progress * 65);
      car.style.left = Math.min(pos, 75) + '%';
    }

    // Update car position every second along with the countdown
    const _origUpdCD = updCD;
    updCD = function () {
      _origUpdCD();
      if (role === 'rider') updateCarPosition();
    };

    // Show Google Maps link when driver shares
    socket.on('state-update', (s) => {
      if (role === 'rider') {
        const link = document.getElementById('gmapLink');
        if (link && s.liveMapUrl) {
          link.href = s.liveMapUrl;
          link.style.display = 'flex';
        } else if (link) {
          link.style.display = 'none';
        }
      }
    });

    // === Audio ===
    function unlock() { if (typeof navigator.wakeLock !== 'undefined') navigator.wakeLock.request('screen').then(w => wakeLock = w).catch(() => { }); if (audioOK) return;['alertSnd', 'pingSnd', 'errSnd'].forEach(id => { const a = document.getElementById(id); a.play().catch(() => { }); a.pause(); a.currentTime = 0; }); audioOK = true; }
    function ping() { if (!S.sound) return; const a = document.getElementById('pingSnd'); a.currentTime = 0; a.play().catch(() => { }); }
    function err() { if (!S.sound) return; const a = document.getElementById('errSnd'); a.currentTime = 0; a.play().catch(() => { }); }
    function stopAud() { ['alertSnd', 'pingSnd', 'errSnd'].forEach(id => { const a = document.getElementById(id); a.pause(); a.currentTime = 0; }); }

    function doAudio() {
      stopAud();
      if (role === 'driver') {
        if (gs.status === 2) { if (S.sound) document.getElementById('alertSnd').play().catch(() => { }); if (S.vibrate && navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]); }
        else if (gs.status === 4) { ping(); if (S.vibrate && navigator.vibrate) navigator.vibrate([100, 100, 100]); }
        else if (gs.status === 5) { err(); if (S.vibrate && navigator.vibrate) navigator.vibrate([500, 200, 500]); }
      }
      if (role === 'rider') {
        if (gs.status === 3 || gs.status === 4) { ping(); if (S.vibrate && navigator.vibrate) navigator.vibrate([300, 100, 300]); }
        else if (gs.status === 5) { err(); if (S.vibrate && navigator.vibrate) navigator.vibrate([500, 200, 500]); }
      }
    }

    // === Settings ===
    function applyS() { document.getElementById('swSound').className = 'sw' + (S.sound ? ' on' : ''); document.getElementById('swVibe').className = 'sw' + (S.vibrate ? ' on' : ''); }
    function tgl(k) { S[k] = !S[k]; localStorage.setItem('pS', JSON.stringify(S)); applyS(); }
    function saveTags() { const r = document.getElementById('tagEdit').value.trim(); if (!r) return; tags = r.split('\n').map(s => s.trim()).filter(s => s).slice(0, 8); localStorage.setItem('tags', JSON.stringify(tags)); renderChips(); alert('âœ… å·²æ›´æ–°'); }
    function openSett() { document.getElementById('settingsModal').classList.add('open'); document.getElementById('tagEdit').value = tags.join('\n'); fetch('/api/qrcode?room=' + encodeURIComponent(roomId) + '&role=' + role).then(r => r.json()).then(d => { document.getElementById('qrBox').innerHTML = `<img src="${d.qr}" style="width:180px;"><div class="qr-url">${d.url}</div>`; }).catch(() => { document.getElementById('qrBox').innerHTML = 'å¤±æ•—'; }); }
    function closeSett() { document.getElementById('settingsModal').classList.remove('open'); }

    // === Confetti ===
    let pts = [], cFrame = null;
    function confettiGo() { const c = document.getElementById('confetti'), x = c.getContext('2d'); c.style.display = 'block'; c.width = innerWidth; c.height = innerHeight; pts = []; for (let i = 0; i < 100; i++)pts.push({ x: c.width / 2, y: c.height / 2, r: Math.random() * 6 + 2, dx: Math.random() * 10 - 5, dy: Math.random() * -10 - 5, cl: `hsl(${Math.random() * 360},100%,50%)` }); (function dr() { x.clearRect(0, 0, c.width, c.height); pts.forEach(p => { x.beginPath(); x.arc(p.x, p.y, p.r, 0, 2 * Math.PI); x.fillStyle = p.cl; x.fill(); p.x += p.dx; p.y += p.dy; p.dy += 0.2; }); cFrame = requestAnimationFrame(dr); })(); setTimeout(confettiStop, 4000); }
    function confettiStop() { cancelAnimationFrame(cFrame); document.getElementById('confetti').style.display = 'none'; }

    document.body.addEventListener('click', unlock, { once: true });
  </script>
</body>

</html>